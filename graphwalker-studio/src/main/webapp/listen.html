<html>
<head>
    <script type="text/javascript" src="dist/vis.js"></script>


    <script src="dist/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="dist/jquery-ui.min.js" type="text/javascript"></script>

    <!-- Optional custom library to enable 'taphold' events -->
    <script src="dist/taphold.js" type="text/javascript"></script>

    <!-- Finally this plugin itself -->
    <script src="dist/jquery.ui-contextmenu.js" type="text/javascript"></script>

    <script type="text/javascript" src="dist/jquery.hotkeys.js"></script>

    <link href="dist/vis.min.css" rel="stylesheet" type="text/css"/>
    <link href="dist/jquery-ui.css" type="text/css" rel="stylesheet"/>

    <style type="text/css">
        body{
            font-size:11px;
        }
        #tabs { margin-top: 1em; }
        #tabs li .ui-icon-close { float: left; margin: 0.4em 0.2em 0 0; cursor: pointer; }
    </style>
</head>
<body>
<div id="issues">No Issues</div>
<div id="tabs">
    <ul></ul>
</div>

<script type="text/javascript">
    "use strict";

    // Useful links
    // vis: http://visjs.org/
    // vis network doc: http://visjs.org/docs/network/
    // vis network examples: http://visjs.org/network_examples.html
    // vis data doc: http://visjs.org/docs/data/
    // 3rd part example: http://chris.neoxygen.io/articles/easy-graph-visualization-with-vis-dot-js.html

    /*
     ************************************************************************
     * SOME DATA INITIALIZATION, OTHER INIT. EXISTS ELSEWHERE IN CODE...
     ************************************************************************
     */
    var gw3 = '';
    var currentModelid = '';
    var modelIdList = [];
    var modelNamesList = [];
    var generatorList = [];
    var startElementIdList = [];
    var modelActionList = [];
    var nodesList = [];
    var edgesList = [];
    var optionsList = [];
    var visNetworkList = [];


    $(document).ready(function () {
        console.log("ready!");
    });


    /*
     ************************************************************************
     * WEBSOCKET CLIENT
     ************************************************************************
     */
    var wsUri = "ws://localhost:8887";
    var websocket;
    var messageState = testWebSocket();
    function testWebSocket() {
        websocket = new WebSocket(wsUri);
        websocket.onopen = function (evt) {
            onOpen(evt);
        };
        websocket.onclose = function (evt) {
            onClose(evt);
        };
        websocket.onmessage = function (evt) {
            onMessage(evt);
        };
        websocket.onerror = function (evt) {
            onError(evt);
        };
    }
    function onOpen(evt) {
        console.log('onOpen: ' + evt.data);
        var getGW3 = {
            command: "getGW3"
        };
        doSend(JSON.stringify(getGW3));
    }
    function onClose(evt) {
        console.log('onClose: ' + evt.data);
    }
    function onMessage(evt) {
        console.log(evt.data);
        var msg = JSON.parse(event.data);

        switch (msg.command) {
            case "getGW3":
                if (msg.success) {
                    console.log("Command getGW3");

                    var jsonModels = msg.gw3.models;
                    for (var modelIndex = 0; modelIndex < jsonModels.length; modelIndex++) {
                        var jsonModel = JSON.parse(jsonModels[modelIndex]);
                        currentModelid = jsonModel.id;
                        modelNamesList[currentModelid] = jsonModel.name;
                        addTab();

                        generatorList[currentModelid] = jsonModel.generator;

                        if (jsonModel.hasOwnProperty('startElementId')) {
                            startElementIdList[currentModelid] = jsonModel.startElementId;
                        }
                        if (jsonModel.hasOwnProperty('actions')) {
                            modelActionList[currentModelid] = jsonModel.actions;
                        }

                        var jsonVertices = jsonModel.vertices;
                        for (var i = 0; i < jsonVertices.length; i++) {
                            var jsonVertex = jsonVertices[i];
                            console.log(jsonVertex);
                            var x = 0, y = 0;
                            if (jsonVertex.properties != undefined) {
                                if (jsonVertex.properties["x"] != undefined) {
                                    x = jsonVertex.properties["x"];
                                }
                                if (jsonVertex.properties["y"] != undefined) {
                                    y = jsonVertex.properties["y"];
                                }
                            } else {
                                jsonVertex.properties = {};
                            }

                            var label = '';
                            if (jsonVertex.actions === undefined){
                                label = jsonVertex.name;
                            } else{
                                label = jsonVertex.name + "\n" + jsonVertex.actions;
                            }
                            nodesList[currentModelid].add({
                                id: jsonVertex.id,
                                name: jsonVertex.name,
                                label: label,
                                sharedState: jsonVertex.sharedState,
                                actions: jsonVertex.actions,
                                requirements: jsonVertex.requirements,
                                properties: jsonVertex.properties,
                                x: x,
                                y: y
                            });
                        }
                        var jsonEdges = jsonModel.edges;
                        for (i = 0; i < jsonEdges.length; i++) {
                            var jsonEdge = jsonEdges[i];
                            console.log(jsonEdge);

                            var label = '';
                            if (jsonEdge.guard === undefined){
                                label = jsonEdge.name;
                            } else{
                                label = jsonEdge.name + "\n" + jsonEdge.guard;
                            }
                            if (jsonEdge.actions !== undefined){
                                label += "\n" + jsonEdge.actions;
                            }

                            edgesList[currentModelid].add({
                                id: jsonEdge.id,
                                name: jsonEdge.name,
                                label: label,
                                guard: jsonEdge.guard,
                                actions: jsonEdge.actions,
                                requirements: jsonEdge.requirements,
                                properties: jsonEdge.properties,
                                from: jsonEdge.sourceVertexId,
                                to: jsonEdge.targetVertexId,
                                arrows: 'to'
                            });
                        }

                        var index = $('#tabs a[href="#' + currentModelid + '"]').parent().index();
                        $("#tabs").tabs("option", "active", index);
                        visNetworkList[currentModelid].fit();
                    }
                }
                break;
            case "visitedElement":
                console.log("Command visitedElement. Will color green on (modelId, elementId): " + msg.modelId + ", " + msg.elementId);
                issues.innerHTML = "Steps: " + msg.totalCount + ", Done: " + (msg.stopConditionFulfillment * 100).toFixed(0) + "%, data: " + JSON.stringify(msg.data);
                visNetworkList[currentModelid].unselectAll();

                currentModelid = msg.modelId;
                var index = $('#tabs a[href="#' + currentModelid + '"]').parent().index();
                $("#tabs").tabs("option", "active", index);

                if (nodesList[currentModelid].get(msg.elementId) !== null) {
                    nodesList[currentModelid].update([{
                        id: msg.elementId,
                        color: {
                            border: "#31B404",
                            background: "#00FF00",
                            highlight: {
                                border: "#31B404",
                                background: "#00FF00"
                            }
                        }
                    }]);
                    visNetworkList[currentModelid].selectNodes([msg.elementId], false);
                } else if (edgesList[currentModelid].get(msg.elementId) !== null) {
                    edgesList[currentModelid].update([{
                        id: msg.elementId,
                        color: {
                            color: "#31B404",
                            highlight: "#31B404"
                        }
                    }]);
                    visNetworkList[currentModelid].selectEdges([msg.elementId]);
                }
                break;
            default:
                break;
        }
    }
    function onError(evt) {
        console.error('Error: ' + evt.data);
    }
    function doSend(message) {
        console.log('Sending msgs: ' + message);
        websocket.send(message);
    }


    /*
     ************************************************************************
     * UTILITY FUNCTIONS
     ************************************************************************
     */

    function addTab() {
        console.log("addTab");
        modelIdList.push(currentModelid);
        var href = "#" + currentModelid;

        var tabs = $("#tabs").tabs();
        var ul = tabs.find("ul");
        $("<li><a href='" + href +"'>" + modelNamesList[currentModelid] + "</a></li>").appendTo(ul);
        $("<div id='" + currentModelid + "'></div>").appendTo(tabs);
        tabs.tabs("refresh");

        $("<style>").prop("type", "text/css").html("\
                    " + href + " {\
                        width: 100%;\
                        height: 100%;\
                        border: 1px solid #444444;\
                        background-color: #dddddd;\
                    }").appendTo("head");

        addVisNetwork();
    }


    /*
     ************************************************************************
     * VIS NETWORK INITIALIZATION
     ************************************************************************
     */
    function addVisNetwork() {
        console.log("addVisNetwork");
        var container = document.getElementById(currentModelid);
        var options = {
            interaction: {
                multiselect: true,
                selectConnectedEdges: false
            },
            manipulation: {
                enabled: true
            },
            nodes: {
                physics: false,
                shape: 'box',
                shadow: true,
                color: {
                    border: '#2B7CE9',
                    background: '#97C2FC',
                    highlight: {
                        border: '#2B7CE9',
                        background: '#D2E5FF'
                    },
                    hover: {
                        border: '#2B7CE9',
                        background: '#D2E5FF'
                    }
                }
            },
            edges: {
                shadow: true,
                arrows: {
                    to: {
                        enabled: true,
                        scaleFactor: 1
                    }
                },
                smooth: true,
                color: {
                    color: '#2B7CE9',
                    highlight: '#2B7CE9',
                    hover: '#2B7CE9'
                }
            }
        };
        optionsList[currentModelid] = options;

        // initialize your network!
        var nodesArray = [];
        var nodes = new vis.DataSet(nodesArray);
        nodesList[currentModelid] = nodes;

        // create an array with edges
        var edgesArray = [];
        var edges = new vis.DataSet(edgesArray);
        edgesList[currentModelid] = edges;
        var data = {
            nodes: nodes,
            edges: edges
        };
        var network = new vis.Network(container, data, options);
        console.log("  Adding network: " + network);
        visNetworkList[currentModelid] = network;

        /*
         ************************************************************************
         * VIS EVENT HANDLING
         ************************************************************************
         */
        nodes.on('*', function (event, properties, senderId) {
            console.log('nodes data update event:', event, 'properties:', properties, 'senderId:', senderId);
        });
        edges.on('*', function (event, properties, senderId) {
            console.log('edges data update event:', event, 'properties:', JSON.stringify(properties), 'senderId:', senderId);
        });
    }

</script>
</body>
</html>
