<html>
<head>
    <script type="text/javascript" src="dist/vis.js"></script>
    <script type="text/javascript" src="dist/jquery-1.11.3.js"></script>
    <script type="text/javascript" src="dist/jquery.hotkeys.js"></script>
    <link href="dist/vis.min.css" rel="stylesheet" type="text/css"/>
    <link href="dist/jquery.contextmenu.css" rel="stylesheet" type="text/css"/>

    <style type="text/css">
        #mynetwork {
            width: 100%;
            height: 100%;
            border: 1px solid #444444;
            background-color: #dddddd;
        }
    </style>
</head>
<body>
<form id="jsonFile" name="jsonFile" enctype="multipart/form-data" method="post">
    <fieldset>
        <input type='file' id='files' name="files[]">
        <input id="inputFileNameToSaveAs">
        <button onclick="saveGraphAsFile()">Save</button>
        <div id="generator-div"><input type="text" id="generator" onchange="onGeneratorChange(this.value)"></div>
        <div id="issues">No Issues</div>
        <button type='button' id="runModel" onclick="onRunModel()">Run model</button>
        <button type='button' id="resetModel" onclick="onResetModel()">Reset</button>
        <button type='button' id="pausePlayExecution" onclick="onPausePlayExecution(this)" value="Pause">Pause</button>
        <button type='button' id="stepExecution" onclick="onStepExecution()">Step</button>
    </fieldset>
</form>

<div id="mynetwork"></div>

<script type="text/javascript">
    // Useful links
    // vis: http://visjs.org/
    // vis network doc: http://visjs.org/docs/network/
    // vis network examples: http://visjs.org/network_examples.html
    // vis data doc: http://visjs.org/docs/data/
    // 3rd part example: http://chris.neoxygen.io/articles/easy-graph-visualization-with-vis-dot-js.html

    /*
     ************************************************************************
     * SOME DATA INITIALIZATION, OTHER INIT. EXISTS ELSEWHERE IN CODE...
     ************************************************************************
     */
    var gw3 = '';
    var modelId = '';
    var nodes;
    var edges;
    var pauseExecution = false;
    var stepExecution = false;
    var startElementId;

    /*
     ************************************************************************
     * REACT TO SOME UI EVENTS
     ************************************************************************
     */
    function onPausePlayExecution(element) {
        console.log("pausePlayExecution: " + element.innerHTML + ", pauseExecution: " + pauseExecution);
        stepExecution = false;

        if (pauseExecution) {
            document.getElementById("runModel").disabled = true;
            document.getElementById("resetModel").disabled = true;
            document.getElementById("pausePlayExecution").disabled = false;
            document.getElementById("stepExecution").disabled = true;

            element.innerHTML = 'Pause';
            pauseExecution = false;

            var hasNext = {
                command: "hasNext"
            };
            doSend(JSON.stringify(hasNext));
        } else {
            document.getElementById("runModel").disabled = true;
            document.getElementById("resetModel").disabled = false;
            document.getElementById("pausePlayExecution").disabled = false;
            document.getElementById("stepExecution").disabled = false;

            element.innerHTML = 'Run';
            pauseExecution = true;
        }
    }

    function onStepExecution() {
        console.log("stepExecution");
        document.getElementById("runModel").disabled = true;
        document.getElementById("resetModel").disabled = true;
        document.getElementById("pausePlayExecution").disabled = false;
        document.getElementById("stepExecution").disabled = false;

        stepExecution = true;

        var hasNext = {
            command: "hasNext"
        };
        doSend(JSON.stringify(hasNext));
    }

    function onGeneratorChange(generatorText) {
        console.log(onGeneratorChange + ": " + generatorText);
        var generatorText = document.getElementById("generator").value;
        var setGenerator = {
            command: "setGenerator",
            modelId: modelId,
            generator: generatorText
        };
        doSend(JSON.stringify(setGenerator));
    }


    function getSelectedElement() {
        var selectedElements = network.getSelection();
        if (selectedElements.edges.length === 1) {
            return selectedElements.edges[0];
        } else if (selectedElements.nodes.length === 1) {
            return selectedElements.nodes[0];
        }
        return undefined;
    }


    $(document).ready(function () {
        console.log("ready!");

        document.getElementById('files').addEventListener('change', handleFileSelect, false);

        // Set some defaults on the UI
        defaultUI();

        // React to the s key being pressed.
        // This mimics the user input of setting a shared state on a node
        $(document).on('keyup', null, 's', function () {
            console.log("s!");
            if (contextNode !== undefined) {
                console.log("Will assign SHARED_STATE to node: " + contextNode);
            } else {
                console.log("No element selected on the canvas");
            }
        });

        // React to the e key being pressed.
        // This mimics the user input of setting the next element of execution
        $(document).on('keyup', null, 'e', function () {
            console.log("e!");
            var selectedId = getSelectedElement();
            startElementId = selectedId;
            if (selectedId !== undefined) {
                console.log("Will assign START_ELEMENT to element: " + selectedId);
                var setNextElement = {
                    command: "setNextElement",
                    modelId: modelId,
                    nextElementId: selectedId
                };
                doSend(JSON.stringify(setNextElement));

            } else {
                console.log("No single element selected on the canvas");
            }
        });
    });

    // Run the execution of the state machine
    function onRunModel() {
        document.getElementById("runModel").disabled = true;
        document.getElementById("resetModel").disabled = true;
        document.getElementById("pausePlayExecution").disabled = false;
        document.getElementById("stepExecution").disabled = true;

        stepExecution = false;
        pauseExecution = false;

        var start = {
            command: "start",
            gw3: {
                name: "VISMODEL",
                models: [
                    {
                        name: "model 1",
                        id: modelId,
                        vertices: [],
                        edges: []
                    }
                ]
            }
        };
        if (document.getElementById("generator").value !== undefined) {
            start.gw3.models[0].generator = document.getElementById("generator").value;
        }
        if (startElementId !== undefined) {
            start.gw3.models[0].startElementId = startElementId;
        }
        for (var i = 0; i < nodes.length; i++) {
            var n = nodes.getIds()[i];
            var vertex = {
                id: nodes.get(n).id,
                name: nodes.get(n).label
            };
            start.gw3.models[0].vertices[i] = vertex;
        }
        for (var i = 0; i < edges.length; i++) {
            var e = edges.getIds()[i];
            var edge = {
                id: edges.get(e).id,
                name: edges.get(e).label,
                sourceVertexId: edges.get(e).from,
                targetVertexId: edges.get(e).to
            };
            start.gw3.models[0].edges[i] = edge;
        }

        doSend(JSON.stringify(start));
    }

    // Reset the state machine to it's initial state
    function onResetModel() {
        document.getElementById("runModel").disabled = false;
        document.getElementById("resetModel").disabled = false;
        document.getElementById("pausePlayExecution").disabled = true;
        document.getElementById("stepExecution").disabled = true;

        options.nodes.color.background = "#97C2FC";
        options.nodes.color.border = "#2A7BE8";
        options.nodes.color.highlight.background = "#D2E5FF";
        options.nodes.color.highlight.border = "#2B7CE9";
        options.edges.color.color = "#2B7CE9";
        options.edges.color.highlight = "#2B7CE9";
        network.setOptions(options);

        for (var i = 0; i < nodes.length; i++) {
            var node = nodes.getIds()[i];
            nodes.update([{id: node, color: {border: "#2A7BE8", background: "#97C2FC"}}]);
        }
        for (var i = 0; i < edges.length; i++) {
            var edge = edges.getIds()[i];
            edges.update([{id: edge, color: {color: "#2B7CE9"}}]);
        }
    }


    /*
     ************************************************************************
     * CREATE SOME CUSTOM EVENTS THAT HANDLES MODEL EXECUTION
     ************************************************************************
     */
    var startEvent = new CustomEvent("startEvent", {});
    document.addEventListener("startEvent", function (e) {
        console.log("startEvent:");

        // Change default coloring for nodes and edges.
        options.nodes.color.highlight.background = "#669966";
        options.nodes.color.highlight.border = "#669900";
        options.edges.color.highlight = "#669966";
        network.setOptions(options);

        // Change some UI elements
        document.getElementById("runModel").disabled = true;
        document.getElementById("resetModel").disabled = true;
        document.getElementById("pausePlayExecution").disabled = false;
        document.getElementById("stepExecution").disabled = true;

        var hasNext = {
            command: "hasNext"
        };
        doSend(JSON.stringify(hasNext));
    });

    var hasNextEvent = new CustomEvent("hasNextEvent", {});
    document.addEventListener("hasNextEvent", function (e) {
        console.log("hasNextEvent pauseExecution: " + pauseExecution + ", stepExecution: " + stepExecution);
        if (pauseExecution) {
            if (!stepExecution) {
                return;
            }
        }
        var getNext = {
            command: "getNext"
        };
        doSend(JSON.stringify(getNext));
    });

    var getNextEvent = new CustomEvent("getNextEvent", {"id": "", "name": ""});
    document.addEventListener("getNextEvent", function (e) {
        console.log("getNextEvent: " + e.id + ": " + e.name + "pauseExecution: " + pauseExecution + ", stepExecution: " + stepExecution);

        if (stepExecution) {
            stepExecution = false;
            return;
        }

        var hasNext = {
            command: "hasNext"
        };
        setTimeout(function () {
            doSend(JSON.stringify(hasNext));
        }, 250);
    });


    /*
     ************************************************************************
     * FILE LOADING AND SAVING
     ************************************************************************
     */
    function saveGraphAsFile() {
        var graphToWrite = {
            name: "VISMODEL",
            models: [
                {
                    name: "model 1",
                    id: modelId,
                    vertices: [],
                    edges: []
                }
            ]
        };
        if (document.getElementById("generator").value !== undefined) {
            graphToWrite.models[0].generator = document.getElementById("generator").value;
        }
        if (startElementId !== undefined) {
            graphToWrite.models[0].startElementId = startElementId;
        }
        for (var i = 0; i < nodes.length; i++) {
            var n = nodes.getIds()[i];
            var vertex = {
                id: nodes.get(n).id,
                name: nodes.get(n).label
            };
            graphToWrite.models[0].vertices[i] = vertex;
        }
        for (var i = 0; i < edges.length; i++) {
            var e = edges.getIds()[i];
            var edge = {
                id: edges.get(e).id,
                name: edges.get(e).label,
                sourceVertexId: edges.get(e).from,
                targetVertexId: edges.get(e).to
            };
            graphToWrite.models[0].edges[i] = edge;
        }

        var textFileAsBlob = new Blob([JSON.stringify(graphToWrite)], {type: 'application/json'});
        var fileNameToSaveAs = document.getElementById("inputFileNameToSaveAs").value;

        var downloadLink = document.createElement("a");
        downloadLink.download = fileNameToSaveAs;
        downloadLink.innerHTML = "Download File";
        if (window.webkitURL != null) {
            // Chrome allows the link to be clicked
            // without actually adding it to the DOM.
            downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
        }
        else {
            // Firefox requires the link to be added to the DOM
            // before it can be clicked.
            downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
            downloadLink.onclick = destroyClickedElement;
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
        }

        downloadLink.click();
    }

    function handleFileSelect(evt) {
        var fr;
        var file = evt.target.files[0];

        edges.clear();
        nodes.clear();
        fr = new FileReader();
        fr.onload = receivedText;
        fr.readAsText(file);
        console.log(fr);

        function receivedText(e) {

            var jsonLoadModel = JSON.parse(e.target.result);
            var jsonModels = jsonLoadModel.models;
            var jsonModel = jsonModels[0];
            if (jsonModel.hasOwnProperty('id')) {
                modelId = jsonModel.id;
            } else {
                modelId = generateUUID();
                jsonLoadModel.model.id = modelId;
            }

            if (jsonModel.hasOwnProperty('generator')) {
                document.getElementById("generator").value = jsonModel.generator;
            }

            if (jsonModel.hasOwnProperty('startElementId')) {
                startElementId = jsonModel.startElementId;
            }

            var jsonVertices = jsonModel.vertices;
            for (var i = 0; i < jsonVertices.length; i++) {
                var jsonVertex = jsonVertices[i];
                console.log(jsonVertex);

                var arrayOfKeys = [];
                for (var key in jsonVertex.properties) {
                    arrayOfKeys.push(key);
                }

                if (arrayOfKeys.length > 1) {
                    nodes.add({
                        id: jsonVertex.id,
                        label: jsonVertex.name,
                        x: jsonVertex.properties['x'],
                        y: jsonVertex.properties['y']
                    });
                } else {
                    nodes.add({
                        id: jsonVertex.id,
                        label: jsonVertex.name
                    });
                }
            }
            var jsonEdges = jsonModel.edges;
            for (var i = 0; i < jsonEdges.length; i++) {
                var jsonEdge = jsonEdges[i];
                console.log(jsonEdge);
                edges.add({
                    id: jsonEdge.id,
                    from: jsonEdge.sourceVertexId,
                    to: jsonEdge.targetVertexId,
                    label: jsonEdge.name,
                    arrows: 'to'
                });
            }

            network.fit();
        }
    }


    /*
     ************************************************************************
     * VIS NETWORK INITIALIZATION
     ************************************************************************
     */
    var container = document.getElementById('mynetwork');
    var options = {
        interaction: {
            multiselect: true,
            selectConnectedEdges: false
        },
        manipulation: {
            enabled: true
        },
        nodes: {
            physics: false,
            shape: 'box',
            shadow: true,
            color: {
                border: '#2B7CE9',
                background: '#97C2FC',
                highlight: {
                    border: '#2B7CE9',
                    background: '#D2E5FF'
                },
                hover: {
                    border: '#2B7CE9',
                    background: '#D2E5FF'
                }
            }
        },
        edges: {
            shadow: true,
            arrows: {
                to: {
                    enabled: true,
                    scaleFactor: 1
                }
            },
            shadow: true,
            smooth: true,
            color: {
                color: '#2B7CE9',
                highlight: '#2B7CE9',
                hover: '#2B7CE9'
            }
        },
    };

    // initialize your network!
    var nodesArray = [];
    nodes = new vis.DataSet(nodesArray);

    // create an array with edges
    edgesArray = [];
    edges = new vis.DataSet(edgesArray);
    var data = {
        nodes: nodes,
        edges: edges
    };
    var network = new vis.Network(container, data, options);
    var contextNode;
    var contextEdge;


    /*
     ************************************************************************
     * VIS EVENT HANDLING
     ************************************************************************
     */
    network.on('oncontext', function (params) {
        params.event.preventDefault();
        console.log(network.getPositions());
        contextNode = network.getNodeAt(params.pointer.DOM);
        contextEdge = network.getEdgeAt(params.pointer.DOM);
        console.log("Node: " + contextNode + ", Edge: " + contextEdge);
    });
    network.on('stabilized', function (params) {
        console.log("Done with initial layout");
    });

    var startNode, endNode;
    network.on('dragStart', function (params) {
        console.log("dragStart");
//        startNode = network.findNode(network.getNodeAt(params.pointer.DOM))[0];
//        if (startNode != undefined) {
//            startNode.allowedToMoveX = false;
//            startNode.allowedToMoveY = false;
//        }
    });
    network.on('dragEnd', function (params) {
        console.log("dragEnd");
//        endNode = network.findNode(network.getNodeAt(params.pointer.DOM))[0];
//        if (startNode != undefined) {
//            startNode.allowedToMoveX = true;
//            startNode.allowedToMoveY = true;
//        }
    });
    network.on('dragging', function (params) {
        console.log("dragging");
    });
    network.on('doubleClick', function (params) {
        console.log("doubleClick");
        var node = network.getNodeAt(params.pointer.DOM);
        var edge = network.getEdgeAt(params.pointer.DOM);
        if (node == undefined && edge == undefined) {
            nodes.add({
                id: generateUUID(),
                label: 'v_NewVertex',
                x: params.pointer.canvas.x,
                y: params.pointer.canvas.y
            });
        }
    });
    nodes.on('*', function (event, properties, senderId) {
        console.log('nodes data update event:', event, 'properties:', properties, 'senderId:', senderId);
    });
    edges.on('*', function (event, properties, senderId) {
        console.log('edges data update event:', event, 'properties:', JSON.stringify(properties), 'senderId:', senderId);
    });


    /*
     ************************************************************************
     * WEBSOCKET CLIENT
     ************************************************************************
     */
    var wsUri = "ws://localhost:9999";
    var websocket;
    var messageState =
            testWebSocket();
    function testWebSocket() {
        websocket = new WebSocket(wsUri);
        websocket.onopen = function (evt) {
            onOpen(evt)
        };
        websocket.onclose = function (evt) {
            onClose(evt)
        };
        websocket.onmessage = function (evt) {
            onMessage(evt)
        };
        websocket.onerror = function (evt) {
            onError(evt)
        };
    }
    function onOpen(evt) {
        console.log('onOpen: ' + evt.data);
    }
    function onClose(evt) {
        console.log('onClose: ' + evt.data);
    }
    function onMessage(evt) {
        console.log(evt.data);
        var msg = JSON.parse(event.data);
        generator.innerHTML = "No issues";

        switch (msg.command) {
            case "hasNext":
                if (msg.success) {
                    console.log("Command hasNext: " + msg.hasNext);
                    if (msg.hasNext) {
                        hasNextEvent.fullfilled = msg.hasNext;
                        document.dispatchEvent(hasNextEvent);
                    } else {
                        defaultUI();
                        document.getElementById("runModel").disabled = true;
                    }
                } else {
                    defaultUI();
                }
                break;
            case "getNext":
                if (msg.success) {
                    console.log("Command getNext ok");
                    document.dispatchEvent(getNextEvent, msg.id, msg.name);
                } else {
                    defaultUI();
                }
                break;
            case "start":
                if (msg.success) {
                    console.log("Command start ok");
                    document.dispatchEvent(startEvent);
                } else {
                    defaultUI();
                }
                break;
            case "issues":
                issues.innerHTML = msg.issues;
                break;
            case "noIssues":
                issues.innerHTML = "No issues";
                break;
            case "visitedElement":
                console.log("Command visitedElement. Will color green on: " + msg.id);
                network.unselectAll();
                if (nodes.get(msg.id) !== null) {
                    nodes.update([{id: msg.id, color: {border: "#31B404", background: "#00FF00"}}]);
                    network.selectNodes([msg.id], false);
                } else if (edges.get(msg.id) !== null) {
                    edges.update([{id: msg.id, color: {color: "#31B404"}}]);
                    network.selectEdges([msg.id]);
                }
                break;
        }
    }
    function onError(evt) {
        console.error('Error: ' + evt.data);
    }
    function doSend(message) {
        console.log('Sending msgs: ' + message);
        websocket.send(message);
    }


    /*
     ************************************************************************
     * UTILITY FUNCTIONS
     ************************************************************************
     */
    function defaultUI() {
        document.getElementById("runModel").disabled = false;
        document.getElementById("resetModel").disabled = false;
        document.getElementById("pausePlayExecution").disabled = true;
        document.getElementById("stepExecution").disabled = true;
        document.getElementById("pausePlayExecution").innerHTML = "Pause";
    }

    function generateUUID() {
        var d = new Date().getTime();
        var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = (d + Math.random() * 16) % 16 | 0;
            d = Math.floor(d / 16);
            return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
        return uuid;
    }
</script>
</body>
</html>
